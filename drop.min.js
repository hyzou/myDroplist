/* * author:zhy date:2019-4-12 */
(function($){$.fn.extend({drop:function(option){var $dom=$(this),$dropbox,settings={title:'mydrop',placeholder:'请选择',data:null,ajaxUrls:'',ajaxMethods:'',ajaxCompNames:[],ajaxPramas:[],keyword:'',value:'',order:'',successKey:'',successCode:'',successData:'',},$defaultData={defaultKeys:[],defaultValues:[]};$.extend(settings,option);$dom.addClass("zhydropdown");$dom.append("<input class='zhydropHolder' type='text' placeholder='"+settings.placeholder+"' readonly >");$dom.append("<div class='dropdownBox zhydropHide'></div>");$dropbox=$dom.find(".dropdownBox");$dropbox.css({"top":$dom.css("height")});if(settings.data&&!settings.ajaxUrls){$.each(settings.data,function(key,value){if(value instanceof Array){$defaultData.defaultKeys.push(key);$defaultData.defaultValues.push(value)}});$.each($defaultData.defaultValues,function(index,item){(function(i){var selectStr="<select class='dropSelect' name='"+$defaultData.defaultKeys[i]+"'>";$.each(item,function(idx,$it){if(settings.order){selectStr+="<option value='"+$it[settings.keyword]+"'>"+$it[settings.order]+'.'+$it[settings.value]+"</option>"}else{selectStr+="<option value='"+$it[settings.keyword]+"'>"+$it[settings.value]+"</option>"}if(idx==item.length){selectStr+="</select>"}});$dropbox.append(selectStr)})(index)})}else if(!settings.data&&settings.ajaxUrls){var urllists=settings.ajaxUrls.split(","),defaultIdx=0,nextIdx,ajaxPramas={};getUrlParams(urllists[defaultIdx],defaultIdx,ajaxPramas).then(function(req){var selectStr="<select class='dropSelect' name='"+settings.ajaxCompNames[defaultIdx]+"' data-idx='"+defaultIdx+"'>";$.each(req,function(idx,$it){if(settings.order){selectStr+="<option value='"+$it[settings.keyword]+"'>"+$it[settings.order]+'.'+$it[settings.value]+"</option>"}else{selectStr+="<option value='"+$it[settings.keyword]+"'>"+$it[settings.value]+"</option>"}if(idx==$it.length){selectStr+="</select>"}});$dropbox.append(selectStr);nextSelection(defaultIdx);function nextSelection(selIndex){$($dropbox.find(".dropSelect")[selIndex]).on('change',function(){var currentIdx=parseInt($(this).attr("data-idx")),currentVal=$(this).val();if($($dropbox.find(".dropSelect")[currentIdx+1])){$.each($dropbox.find(".dropSelect"),function(index,item){if(index>currentIdx){$(item).remove()}})}if(currentIdx<(urllists.length-1)){var paramName=settings.ajaxPramas[currentIdx+1];var ajaxPramas={};ajaxPramas[paramName]=currentVal;var dropdata=getUrlParams(urllists[currentIdx+1],currentIdx+1,ajaxPramas).then(function(req){var selectStr="<select class='dropSelect' name='"+settings.ajaxCompNames[currentIdx+1]+"' data-idx='"+(currentIdx+1)+"'>";$.each(req,function(idx,$it){if(settings.order){selectStr+="<option value='"+$it[settings.keyword]+"'>"+$it[settings.order]+'.'+$it[settings.value]+"</option>"}else{selectStr+="<option value='"+$it[settings.keyword]+"'>"+$it[settings.value]+"</option>"}if(idx==$it.length){selectStr+="</select>"}});$($dropbox.find(".dropSelect")[currentIdx]).after(selectStr);nextSelection(currentIdx+1);$(document).click(function(){$(".dropdownBox").addClass("zhydropHide")});$(".zhydropdown").on("click",function(event){var e=arguments.callee.caller.arguments[0]||event;if(e&&e.stopPropagation){e.stopPropagation()}else if(window.event){window.event.cancelBubble=true}$(this).find(".dropdownBox").toggleClass("zhydropHide")});$(".dropdownBox").on("click",function(){var eve=event||window.event;eve.stopPropagation()});$(".dropSelect").on("change",function(){var dropvalues='',selectList=$dropbox.find(".dropSelect");$.each(selectList,function(index,item){var itemVal=$(item).find("option:selected").text();if(index==0){dropvalues=itemVal}else{dropvalues=dropvalues+'/'+itemVal}});$(".zhydropHolder").attr({"placeholder":dropvalues,"title":dropvalues})})})}})}})}else{if(!settings.data&&!settings.ajaxUrls){throw("您需要配置ajax请求地址或初始化列表数据")}if(settings.data&&settings.ajaxUrls){throw("您不能同时配置ajax请求地址和初始化列表数据")}}function getUrlParams(url,idx,data){var method;if(settings.ajaxMethods instanceof Array){method=settings.ajaxMethods[idx]}else{method=settings.ajaxMethods}var p=new Promise(function(resolve,reject){$.ajax({type:method,url:url,data:data,dataType:"json",success:function(xhr){if(xhr[settings.successKey]==settings.successCode){resolve(xhr.data)}else{throw("接口请求失败")}},error:function(){throw(url+"接口请求失败")}})});return p}$(document).click(function(){$(".dropdownBox").addClass("zhydropHide")});$(".zhydropdown").on("click",function(event){var e=arguments.callee.caller.arguments[0]||event;if(e&&e.stopPropagation){e.stopPropagation()}else if(window.event){window.event.cancelBubble=true}$(this).find(".dropdownBox").toggleClass("zhydropHide")});$(".dropdownBox").on("click",function(){var eve=event||window.event;eve.stopPropagation()});$(".dropSelect").on("change",function(){var dropvalues='',selectList=$dropbox.find(".dropSelect");$.each(selectList,function(index,item){var itemVal=$(item).find("option:selected").text();if(index==0){dropvalues=itemVal}else{dropvalues=dropvalues+'/'+itemVal}});$(".zhydropHolder").attr({"placeholder":dropvalues,"title":dropvalues})})}})})(jQuery);
